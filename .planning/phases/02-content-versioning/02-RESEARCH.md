# Phase 02: Content & Versioning - Research

**Researched:** 2024-02-22
**Domain:** Content Ingestion, Docusaurus Versioning, Lifecycle UI
**Confidence:** HIGH

## Summary

This phase focuses on establishing a robust bridge between the normative source repository (sandbox) and the public-facing Docusaurus portal (`SIB_pages`). The research confirms that a GitHub Actions-based "pull" model is the most efficient way to handle content ingestion from a private repository using a Personal Access Token (PAT). Docusaurus v3 provides native support for "versioned snapshots" which perfectly aligns with the requirement for frozen normative states.

**Primary recommendation:** Use a GitHub Action in `SIB_pages` that runs on a schedule or manual trigger to sync Markdown content from the sandbox repo, and use Docusaurus "swizzling" to inject lifecycle badges (STABLE/DRAFT) into the document header.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Docusaurus | v3.x | Documentation Framework | Industry standard for MDX-based portals; excellent versioning support. |
| GitHub Actions | N/A | Automation / CI/CD | Native integration with GitHub repositories; handles secrets (PAT) securely. |
| actions/checkout | v4 | Repository Access | Standard way to fetch multi-repo content in workflows. |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|--------------|
| rsync / cp | N/A | File Synchronization | Used within GitHub Actions to move content from sandbox to `docs/`. |
| React | v18 | UI Customization | Required for swizzling Docusaurus components to add badges. |

## Architecture Patterns

### Recommended Sync Workflow: "The Pull Model"
A dedicated workflow file `.github/workflows/sync-content.yml` in `SIB_pages` that:
1.  Checkouts `SIB_pages`.
2.  Checkouts `SIB-normativa-artefakter-sandbox` into a subfolder using a PAT.
3.  Copies relevant `.md` files and folder structure into `docs/`.
4.  Commits changes back to `SIB_pages` (triggering the deploy workflow).

### Pattern 1: Versioning Snapshots
Docusaurus versioning is a "copy-on-freeze" mechanism.
-   **Current docs:** Lives in `docs/` (tracks the latest state from sandbox).
-   **Snapshots:** Created via `npm run docusaurus docs:version <tag>`.
-   **Persistence:** Copies current `docs/` content to `versioned_docs/version-<tag>/`.

### Pattern 2: Lifecycle Metadata via Frontmatter
Use custom frontmatter fields to drive UI elements.
-   `status`: `stable` | `draft`
-   `sidebar_custom_props`: Used for badges in the sidebar (if needed).

### Anti-Patterns to Avoid
-   **Git Submodules:** Hard to manage with GitHub Actions and often lead to "detached HEAD" or authentication issues in CI.
-   **Manual Copy-Paste:** Prevents a "Single Source of Truth" and leads to drift.
-   **Hardcoding Versions:** Always use the Docusaurus CLI to manage versions to ensure `versions.json` and sidebars stay in sync.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Private Repo Sync | Custom API proxy | `actions/checkout` + PAT | Secure, maintained, and natively integrated. |
| Version Switcher | Custom React UI | Docusaurus `docs-versioning` | Native plugin handles URL mapping and SEO automatically. |
| Sidebar Logic | Manual JSON | `autogenerated` sidebars | Automatically maps folder structure from sandbox to navigation. |

## Common Pitfalls

### Pitfall 1: PAT Expiration
**What goes wrong:** The sync workflow fails suddenly after 30/60/90 days.
**How to avoid:** Use a **Fine-grained Personal Access Token** with a long expiration (or no expiration if organization policy allows) and only "Read" access to contents.
**Warning signs:** GitHub Action logs show "Authentication failed" or "403 Forbidden".

### Pitfall 2: MDX v3 Breaking Changes
**What goes wrong:** Markdown that worked in Sandbox (or Docusaurus v2) fails in Docusaurus v3.
**Why:** MDX v3 is stricter about HTML tags, `{}` braces, and unclosed tags.
**How to avoid:** Run `npm run build` in the sync action to validate content before committing.

### Pitfall 3: Directory Overlap
**What goes wrong:** Syncing the sandbox repo overwrites `docs/intro.md` or other site-specific files.
**How to avoid:** Use a dedicated subfolder in the sandbox (e.g., `artefakter/`) or use `rsync` with exclude patterns.

## Code Examples

### 1. Sync Content Workflow (`.github/workflows/sync-content.yml`)
```yaml
name: Sync Content from Sandbox
on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 0 * * *' # Daily sync

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout SIB_pages
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Sandbox
        uses: actions/checkout@v4
        with:
          repository: johantjader/SIB-normativa-artefakter-sandbox
          token: ${{ secrets.SANDBOX_REPO_PAT }}
          path: sandbox-repo

      - name: Sync Files
        run: |
          # Create docs dir if not exists
          mkdir -p docs
          # Copy content from sandbox subfolder to docs
          # Adjust path if artifacts are in a specific subfolder
          rsync -av --delete --exclude '.git*' --exclude 'README.md' sandbox-repo/ docs/
          rm -rf sandbox-repo

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git diff-index --quiet HEAD || git commit -m "chore: sync content from sandbox [skip ci]"
          git push
```

### 2. Lifecycle Badge Swizzle (`src/theme/DocItem/Header/index.tsx`)
*Command to generate: `npm run swizzle @docusaurus/theme-classic DocItem/Header -- --wrap`*

```tsx
import React from 'react';
import Header from '@theme-original/DocItem/Header';
import type HeaderType from '@theme/DocItem/Header';
import type {WrapperProps} from '@docusaurus/types';
import {useDoc} from '@docusaurus/plugin-content-docs/client';

type Props = WrapperProps<typeof HeaderType>;

export default function HeaderWrapper(props: Props): JSX.Element {
  const {frontMatter} = useDoc();
  const status = frontMatter.status as string | undefined;

  const badgeColors: Record<string, string> = {
    stable: '#28a745', // Green
    draft: '#ffc107',  // Yellow/Orange
  };

  return (
    <>
      <Header {...props} />
      {status && (
        <div style={{
          display: 'inline-block',
          padding: '2px 8px',
          borderRadius: '4px',
          fontSize: '0.8rem',
          fontWeight: 'bold',
          color: status === 'draft' ? '#000' : '#fff',
          backgroundColor: badgeColors[status.toLowerCase()] || '#6c757d',
          marginBottom: '1rem',
          textTransform: 'uppercase'
        }}>
          {status}
        </div>
      )}
    </>
  );
}
```

### 3. Sidebar Category Configuration (`docs/viktiga-artefakter/_category_.json`)
```json
{
  "label": "Viktiga Artefakter",
  "position": 2,
  "link": {
    "type": "generated-index",
    "description": "Översikt över alla viktiga normativa artefakter i denna kategori."
  }
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Git Submodules | GitHub Action Sync | ~2020 | Better reliability, no "detached head" issues. |
| Manual Badge in MDX | Swizzled DocItem | Docusaurus v2/v3 | Separation of content and presentation; consistent UI. |
| Hardcoded Sidebars | Autogenerated + `_category_.json` | Docusaurus v2 | Scalable navigation; folder structure is the source of truth. |

## Open Questions

1.  **Sandbox Repo Layout:** Does the sandbox repo contain only `.md` files or also assets (images)?
    - *Recommendation:* Ensure `rsync` copies images/assets to the same relative paths in `docs/`.
2.  **Versioning Frequency:** How often will snapshots be created?
    - *Recommendation:* Define a naming convention (e.g., `YYYY-MM-DD` or `v1.x.x`) early.
3.  **Permissions:** Who manages the `SANDBOX_REPO_PAT`?
    - *Recommendation:* Use a service account or a specific "Bot" user if possible, rather than a personal account.

## Sources

### Primary (HIGH confidence)
- [Docusaurus v3 Documentation](https://docusaurus.io/docs/versioning) - Versioning CLI and concepts.
- [Docusaurus Swizzling Guide](https://docusaurus.io/docs/swizzling) - Wrapping components for custom UI.
- [GitHub Actions Checkout v4](https://github.com/actions/checkout) - Multi-repo checkout patterns.

### Secondary (MEDIUM confidence)
- [WebSearch: Syncing private repos](https://github.com/marketplace/actions/sync-branch) - General community patterns for repo syncing.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Docusaurus and GH Actions are industry standard.
- Architecture: HIGH - Pull model is robust and easy to debug.
- Pitfalls: HIGH - Common issues with PATs and MDX v3 are well-documented.

**Research date:** 2024-02-22
**Valid until:** 2024-05-22
